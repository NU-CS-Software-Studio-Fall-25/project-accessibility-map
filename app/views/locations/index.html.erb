<% content_for :title, "Search Locations" %>

<h2 class="sr-only">Search Locations</h2>

<div class="absolute inset-0 flex overflow-hidden">
  <% current_lat = params[:latitude].to_f || 42.057853 %>
  <% current_lng = params[:longitude].to_f || -87.676143 %>
  <%
    # Convert paginated locations to format expected by js_map
    # js_map will automatically center and zoom to fit all locations
    map_locations = @locations.select { |loc| loc.latitude.present? && loc.longitude.present? }.map do |location|
      {
        latitude: location.latitude,
        longitude: location.longitude,
        tooltip: tooltip_link_to(location)
      }
    end

    # If no locations, use default center (Evanston, IL)
      map_options = {
        controls: true,
        tooltips: { hover: false, html: true},
        width: "100%",
        height: "100%",
      id: "locations-map"
    }

    # If there are locations, mapkick will auto-center. If not, center on default location.
    if map_locations.empty?
      map_options[:library] = {
          center: [current_lng, current_lat],
          zoom: 13
        }
    end
  %>
  <div class="sm:block hidden flex-1 lg:flex-2 min-w-1/2 min-h-0"
       data-controller="geolocation"
       data-geolocation-locations-url-value="<%= locations_path(format: :json, query: params[:query]) %>"
       data-geolocation-initial-lat-value="<%= current_lat %>"
       data-geolocation-initial-lng-value="<%= current_lng %>">
    <%= js_map map_locations, **map_options %>
  </div>

  <section id="locations_list" class="flex-1 max-w-full min-h-0 flex flex-col space-y-4 justify-start items-stretch overflow-hidden">
    <div class="flex flex-col gap-2 flex-shrink-0">
      <%= render "locations/search_form" %>
      <%= render "locations/filters_button" %>
    </div>
    <div class="h-[1px] bg-gray-200 mx-4 flex-shrink-0"></div>

    <%= render "locations/filters_modal" %>

    <div class="flex-1 min-h-0 min-w-0 max-w-full overflow-x-hidden overflow-y-auto">
      <%= render "locations_list" %>
    </div>

  </section>
</div>
