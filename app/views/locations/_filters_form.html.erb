<%= form_with url: locations_path, method: :get, id: "filters-form", class: "space-y-4" do %>
  <!-- Hidden fields to preserve search and location params -->
  <%= hidden_field_tag :query, params[:query] if params[:query].present? %>
  <%= hidden_field_tag :latitude, params[:latitude] if params[:latitude].present? %>
  <%= hidden_field_tag :longitude, params[:longitude] if params[:longitude].present? %>

  <!-- Favorites filter -->
  <% if current_user %>
    <div class="border-b border-gray-200 pb-4">
      <label class="flex items-center gap-2 cursor-pointer" for="favorites_only">
        <%= check_box_tag "favorites_only",
              "1",
              params[:favorites_only] == "1",
              id: "favorites_only",
              class: "h-4 w-4" %>
        <span class="text-sm font-medium text-gray-900">Show only favorites</span>
      </label>
    </div>
  <% end %>

  <!-- Features filter -->
  <div>
    <p class="block text-sm font-medium text-gray-900 mb-3">Filter by features</p>

    <!-- Features list grouped by category -->
    <% Feature.order(:feature_category, :feature).group_by(&:feature_category).each do |category, features| %>
      <div class="mb-4 feature-category" data-category="<%= category.downcase.gsub(/\s+/, '-') %>">
        <h3 class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2 px-1"><%= category %></h3>
        <div class="space-y-1">
          <% features.each do |feature| %>
            <% checkbox_id = "feature_#{feature.id}" %>
            <label class="flex items-center gap-2 px-2 py-1.5 text-sm hover:bg-gray-50 rounded feature-item"
                   data-feature-name="<%= feature.feature.downcase %>"
                   for="<%= checkbox_id %>">
              <%= check_box_tag "feature_ids[]",
                    feature.id,
                    params[:feature_ids]&.include?(feature.id.to_s),
                    id: checkbox_id,
                    class: "h-4 w-4" %>
              <span><%= feature.feature %></span>
            </label>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
