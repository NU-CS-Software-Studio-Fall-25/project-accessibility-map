<%= form_with(model: location, class: "space-y-5 text-sm",
      data: {
        controller: "address-autocomplete image-preview",
        address_autocomplete_access_token_value: ENV['MAPBOX_ACCESS_TOKEN'],
        address_autocomplete_current_address_value: location.persisted? ? "#{location.address}, #{location.city}, #{location.state} #{location.zip}, #{location.country}" : ""
      }) do |f| %>
  <% if location.errors.any? %>
    <aside class="rounded-md bg-red-50 p-4 text-red-700" role="alert" aria-live="polite">
      <p class="font-semibold mb-2"><%= pluralize(location.errors.count, "error") %> prohibited this location from being saved:</p>
      <ul class="list-disc pl-5">
        <% location.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </aside>
  <% end %>

  <div class="space-y-2">
    <%= f.label :name, "Location Name", class: "block font-medium" %>
    <%= f.text_field :name, placeholder: "ex. Moge Tee",
          class: "shadow-sm text-sm w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400" %>
  </div>

  <div class="space-y-2">
    <div class="space-y-2">
      <%= f.label :pictures, "Photos", class: "block font-medium" %>
      <%= f.file_field :pictures, multiple: true, accept: "image/png,image/jpeg,image/jpg", data: { action: "change->image-preview#displayPreviews", "image-preview-target": "fileInput" } %>
    </div>

    <div class="flex gap-4 overflow-x-auto">
      <% if location.pictures.attached? %>
        <% location.pictures.each do |picture| %>
          <% next unless picture.persisted? %>
          <% next unless picture.variable? %>
          <div class="relative group flex-shrink-0">
            <% begin %>
              <%= image_tag picture.variant(resize_to_limit: [nil, 200]), alt: picture.blob.metadata["alt_text"], class: "h-64 object-cover rounded-lg" %>
              <!-- Add alt text -->
              <div class="mt-2 pt-2 pb-2">
                <% alt_text_id = "alt_text_#{picture.blob.id}" %>
                <%= label_tag alt_text_id, "Alt text for this image", class: "block text-xs font-medium" %>

                <%= text_field_tag "location[alt_texts][#{picture.blob.id}]",
                      picture.blob.metadata["alt_text"],
                      id: alt_text_id,
                      class: "shadow-sm text-sm w-full rounded-md border border-gray-300 px-2 py-1",
                      autocomplete: "off" %>
              </div>
              <!-- Hover to have option to delete loation photo -->
                  <%= link_to "Delete",
                      delete_picture_location_path(location, picture_id: picture.id),
                      method: :delete,
                      data: { turbo_method: "delete", turbo_confirm: "Are you sure you want to delete this image?" },
                      "aria-label": "Delete image",
                      class: "text-sm absolute top-2 right-2 bg-red-500 hover:bg-red-700 focus:opacity-100 text-white text-xs font-bold py-1 px-2 rounded opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-opacity focus:outline-none focus:ring-2 focus:ring-red-300" %>
            <% rescue => e %>
              <% Rails.logger.error("Variant render failed for attachment #{picture.id}: #{e.class} #{e.message}") %>
              <% next %>
            <% end %>
          </div>
        <% end %>
      <% end %>

      <div data-image-preview-target="previewContainer" class="contents"></div>
    </div>
  </div>

  <div class="space-y-2">
    <%= f.label :feature_ids, "Features", class: "block font-medium" %>
    <% grouped = Feature.all.group_by(&:feature_category) %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% grouped.each do |category, features| %>
        <div>
          <h4 class="font-semibold text-gray-800 mb-2"><%= category %></h4>
          <div class="space-y-2">
            <% features.each do |feature| %>
              <label class="flex items-center space-x-2 bg-gray-100 hover:bg-yellow-100 px-3 py-1.5 rounded-md cursor-pointer">
                <%= check_box_tag "location[feature_ids][]",
                  feature.id,
                  @location.features.include?(feature),
                  class: "text-sm rounded text-yellow-500 focus:ring-yellow-400" %>
                <span class="text-gray-800"><%= feature.feature %></span>
              </label>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="space-y-2">
    <%= f.label :address, "Address", class: "block font-medium" %>
    <div class="relative">
      <input id="location_address" type="text"
             placeholder="Search for an address..."
             data-address-autocomplete-target="searchInput"
             aria-label="Address search"
             aria-describedby="address-help address-confirmation"
             aria-autocomplete="list"
             aria-expanded="false"
             aria-controls="address-suggestions"
             class="shadow-sm text-sm w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400"
             autocomplete="off">
      <p id="address-help" class="text-xs text-gray-600 mt-1">Start typing and select an address from the suggestions</p>
    </div>

    <!-- Confirmation display -->
    <div id="address-confirmation" data-address-autocomplete-target="confirmationDisplay" class="hidden mt-2" role="status" aria-live="polite"></div>
    <!-- Suggestions dropdown -->
    <div id="address-suggestions" role="listbox" aria-label="Address suggestions" class="hidden"></div>
  </div>

  <!-- Hidden fields for address components -->
  <%= f.hidden_field :address, data: { address_autocomplete_target: "addressField" } %>
  <%= f.hidden_field :city, data: { address_autocomplete_target: "cityField" } %>
  <%= f.hidden_field :state, data: { address_autocomplete_target: "stateField" } %>
  <%= f.hidden_field :zip, data: { address_autocomplete_target: "zipField" } %>
  <%= f.hidden_field :country, data: { address_autocomplete_target: "countryField" } %>
  <%= f.hidden_field :latitude, data: { address_autocomplete_target: "latitudeField" } %>
  <%= f.hidden_field :longitude, data: { address_autocomplete_target: "longitudeField" } %>

  <div class="flex flex-row-reverse flex-wrap gap-2">
    <%= f.submit( location.persisted? ? "Save Changes" : "Add Location",
          class: "text-sm w-full sm:w-auto text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-md px-4 py-2 dark:bg-blue-600 focus:outline-none flex justify-center items-center disabled:opacity-50 disabled:cursor-not-allowed transition",
          data: { address_autocomplete_target: "submitButton" }) %>
    <% if location.persisted? %>
      <%= link_to "Go Back",
            location_path(location),
            class: "text-sm w-full sm:w-auto rounded-md border border-gray-200 bg-white hover:bg-gray-100 px-4 py-2 font-medium transition flex justify-center items-center" %>
    <% else %>
    <%= link_to "Go Back",
          locations_path,
          class: "text-sm w-full sm:w-auto rounded-md border border-gray-200 bg-white hover:bg-gray-100 px-4 py-2 font-medium transition flex justify-center items-center" %>
    <% end %>
  </div>
<% end %>
