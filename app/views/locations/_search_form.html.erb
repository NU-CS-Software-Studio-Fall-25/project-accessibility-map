<%= form_with url: locations_path, method: :get, class: "w-full flex flex-col gap-2 px-4 pt-4", data: { turbo_frame: "locations_list" } do %>
  <div class="flex-1 relative">
    <label for="search_query" class="sr-only">Search locations</label>
    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
      <svg class="w-4 h-4 text-gray-600" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
      </svg>
    </div>

    <%= text_field_tag :query,
      params[:query],
      id: "search_query",
      class: "w-full text-sm py-2 ps-10 rounded-lg border border-gray-200 focus:ring-blue-500 focus:border-blue-500 truncate",
      placeholder: "Search locations",
      autocomplete: "off",
      "aria-label": "Search locations" %>
  </div>

  <%= submit_tag "Search",
    class: "text-white text-sm bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg px-4 py-2" %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[data-turbo-frame="locations_list"]')
    if (!form) return

    form.addEventListener('submit', function(e) {
      const queryInput = form.querySelector('#search_query')
      if (queryInput && !queryInput.value.trim()) {
        e.preventDefault()
        // Remove query param from URL and reload the frame
        const url = new URL(window.location.pathname, window.location.origin)
        // Preserve other params except query and page
        const currentParams = new URLSearchParams(window.location.search)
        ['latitude', 'longitude', 'favorites_only', 'feature_ids'].forEach(param => {
          if (param === 'feature_ids') {
            currentParams.getAll(param).forEach(val => {
              url.searchParams.append(param, val)
            })
          } else {
            const value = currentParams.get(param)
            if (value) {
              url.searchParams.set(param, value)
            }
          }
        })

        // Update the turbo frame
        const frame = document.querySelector('turbo-frame#locations_list')
        if (frame) {
          frame.src = url.toString()
        }
      }
    })
  })
</script>
