<%= form_with url: locations_path, method: :get, class: "w-full flex flex-col gap-2 px-4 pt-4" do %>
  <!-- Hidden fields to preserve filter and location params -->
  <%= hidden_field_tag :latitude, params[:latitude] if params[:latitude].present? %>
  <%= hidden_field_tag :longitude, params[:longitude] if params[:longitude].present? %>
  <%= hidden_field_tag :favorites_only, params[:favorites_only] if params[:favorites_only].present? %>
  <% if params[:feature_ids].present? %>
    <% params[:feature_ids].each do |id| %>
      <%= hidden_field_tag "feature_ids[]", id %>
    <% end %>
  <% end %>

  <div class="flex-1 relative">
    <label for="search_query" class="sr-only">Search locations</label>
    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
      <svg class="w-4 h-4 text-gray-600" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
      </svg>
    </div>

    <%= text_field_tag :query,
      params[:query],
      id: "search_query",
      class: "w-full text-sm py-2 ps-10 rounded-lg border border-gray-200 focus:ring-blue-500 focus:border-blue-500 truncate",
      placeholder: "Search locations",
      autocomplete: "off",
      "aria-label": "Search locations" %>
  </div>

  <%= submit_tag "Search",
    class: "text-white text-sm bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg px-4 py-2" %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action="<%= locations_path %>"]')
    if (!form) return

    form.addEventListener('submit', function(e) {
      e.preventDefault() // Always prevent default to handle query parameter removal

      const queryInput = form.querySelector('#search_query')
      const queryValue = queryInput ? queryInput.value.trim() : ''

      // Build URL
      const url = new URL(form.action, window.location.origin)

      // Get all form data
      const formData = new FormData(form)

      // Add all form fields to URL, but skip query if empty
      for (const [key, value] of formData.entries()) {
        // Skip empty query parameter
        if (key === 'query' && !queryValue) {
          continue
        }

        if (key === 'feature_ids[]') {
          url.searchParams.append('feature_ids[]', value)
        } else {
          url.searchParams.set(key, value)
        }
      }

      // Preserve location params from current URL if not in form
      const currentParams = new URLSearchParams(window.location.search)
      if (!url.searchParams.has('latitude') && currentParams.has('latitude')) {
        url.searchParams.set('latitude', currentParams.get('latitude'))
      }
      if (!url.searchParams.has('longitude') && currentParams.has('longitude')) {
        url.searchParams.set('longitude', currentParams.get('longitude'))
      }

      // Remove page param to start from page 1 when searching/filtering
      url.searchParams.delete('page')

      // Full page reload
      window.location.href = url.toString()
    })
  })
</script>
