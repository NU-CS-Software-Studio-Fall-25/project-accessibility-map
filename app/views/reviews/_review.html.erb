<article class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm space-y-2">
  <div class="flex justify-between items-start gap-4">
    <%= link_to user_path(review.user), class: "flex items-center gap-3 hover:opacity-90 hover:underline underline-offset-4 transition-opacity group" do %>
      <!-- Profile Photo -->
      <div class="flex-shrink-0">
        <% if review.user.photo_url.present? %>
          <%= image_tag review.user.photo_url, class: "w-10 h-10 rounded-full object-cover", alt: review.user.username %>
        <% elsif review.user.profile_photo.attached? %>
          <%= image_tag review.user.profile_photo, class: "w-10 h-10 rounded-full object-cover", alt: review.user.username %>
        <% else %>
          <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
            <span class="text-sm font-bold text-white"><%= review.user.username[0].upcase %></span>
          </div>
        <% end %>
      </div>
      <!-- Username -->
      <span class="text-xl text-gray-900 font-medium transition-colors"><%= review.user.username %></span>
    <% end %>
    <div class="flex gap-3 flex-wrap">
      <% if current_user == review.user %>
        <button data-modal-target="edit-review-modal-<%= review.id %>" data-modal-toggle="edit-review-modal-<%= review.id %>" type="button" class="text-gray-700 text-sm text-nowrap hover:underline underline-offset-4">Edit Review</button>
        <%= link_to "Delete Review", location_review_path(@location, review),
          data: { turbo_method: :delete },
          class: "text-red-500 text-sm text-nowrap hover:underline underline-offset-4 cursor-default" %>
      <% end %>
    </div>
  </div>
  <p class="text-sm font-normal text-gray-800">
    <%= review.body %>
  </p>
</article>

<div id="edit-review-modal-<%= review.id %>" tabindex="-1" aria-hidden="<%= (@review&.id == review.id && @review&.errors&.any?) ? 'false' : 'true' %>" aria-labelledby="edit-review-modal-title-<%= review.id %>" class="<%= (@review&.id == review.id && @review&.errors&.any?) ? '' : 'hidden' %> overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-[800px] max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm">
      <div class="flex items-center justify-between p-4 rounded-t">
        <h2 id="edit-review-modal-title-<%= review.id %>" class="text-xl font-semibold text-gray-900">
          Edit Review
        </h2>

        <button type="button" class="bg-transparent hover:bg-gray-100 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-toggle="edit-review-modal-<%= review.id %>" aria-label="Close edit review modal">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>

      <div class="px-4 pb-4">
        <%= render "reviews/edit_form", review: review, location: review.location %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modalId = <%= "edit-review-modal-#{review.id}".to_json %>;
    const modal = document.getElementById(modalId);
    if (!modal) return;

    let previouslyFocusedElement = null;

    // Open modal if there are validation errors for this review
    const hasReviewErrors = <%= ((@review&.id == review.id && @review&.errors&.any?) ? true : false).to_json %>;
    if (hasReviewErrors && modal.classList.contains('hidden')) {
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    function openModal() {
      previouslyFocusedElement = document.activeElement;
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (firstFocusable) {
        firstFocusable.focus();
      }
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      if (previouslyFocusedElement) {
        previouslyFocusedElement.focus();
      }
    }

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    modal.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];

    modal.addEventListener('keydown', function(e) {
      if (e.key !== 'Tab' || modal.classList.contains('hidden')) return;

      if (e.shiftKey) {
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        }
      } else {
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
    });

    document.querySelectorAll('[data-modal-toggle="' + modalId + '"]').forEach(button => {
      button.addEventListener('click', function() {
        if (modal.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      });
    });
  });
</script>
